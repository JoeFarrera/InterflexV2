package es.sysmap.interflex.model.bdc;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.DecimalFormat;
import oracle.jbo.ApplicationModule;
import oracle.jbo.Row;
import oracle.jbo.ViewObject;
import oracle.jbo.server.EntityImpl;
import oracle.jbo.server.EntityDefImpl;
import oracle.jbo.server.AttributeDefImpl;
import oracle.jbo.domain.Number;
import oracle.jbo.Key;
import oracle.jbo.RowIterator;
import oracle.jbo.domain.Date;
import es.sysmap.interflex.model.bdc.common.FlexiDate;
import oracle.jbo.AttributeList;
//  ---------------------------------------------------------------------
//  ---    File generated by Oracle ADF Business Components Design Time.
//  ---    Custom code may be added to this class.
//  ---    Warning: Do not modify method signatures of generated methods.
//  ---------------------------------------------------------------------

public class SgalbultoImpl extends EntityImpl
{
  public static final int IDBULTO = 0;
  public static final int IDDOC = 1;
  public static final int IDLIN = 2;
  public static final int CANTOT = 3;
  public static final int PESO = 4;
  public static final int CANRES = 5;
  public static final int CANPEN = 6;
  public static final int ESTADO = 7;
  public static final int CREATEDBY = 8;
  public static final int MODIFIEDBY = 9;
  public static final int CREATEDON = 10;
  public static final int MODIFIEDON = 11;
  public static final int IDTIPMAC = 12;
  public static final int RELLENO = 13;
  public static final int UNIMAC = 14;
  public static final int CANENT = 15;
  public static final int IDARTIF = 16;
  public static final int DESCRIP = 17;
  public static final int SGABULTO = 18;
  public static final int SGALDOC = 19;
  public static final int SGARESMAT = 20;
  public static final int SGAEXISTENCIA = 21;







































































  private static SgalbultoDefImpl mDefinitionObject;

  /**
   *
   *  This is the default constructor (do not remove)
   */
  public SgalbultoImpl()
  {
  }

  /**
   * 
   *  Retrieves the definition object for this instance class.
   */
  public static synchronized EntityDefImpl getDefinitionObject()
  {
    if (mDefinitionObject == null)
    {
      mDefinitionObject = (SgalbultoDefImpl)EntityDefImpl.findDefObject("es.sysmap.interflex.model.bdc.Sgalbulto");
    }
    return mDefinitionObject;
  }








































































  /**
   *
   *  Gets the attribute value for Idbulto, using the alias name Idbulto
   */
  public Number getIdbulto()
  {
    return (Number)getAttributeInternal(IDBULTO);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Idbulto
   */
  public void setIdbulto(Number value)
  {
    setAttributeInternal(IDBULTO, value);
  }

  /**
   *
   *  Gets the attribute value for Iddoc, using the alias name Iddoc
   */
  public Number getIddoc()
  {
    return (Number)getAttributeInternal(IDDOC);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Iddoc
   */
  public void setIddoc(Number value)
  {
    setAttributeInternal(IDDOC, value);
  }

  /**
   *
   *  Gets the attribute value for Idlin, using the alias name Idlin
   */
  public Number getIdlin()
  {
    return (Number)getAttributeInternal(IDLIN);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Idlin
   */
  public void setIdlin(Number value)
  {
    setAttributeInternal(IDLIN, value);
  }

  /**
   *
   *  Gets the attribute value for Cantot, using the alias name Cantot
   */
  public Number getCantot()
  {
    return (Number)getAttributeInternal(CANTOT);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Cantot
   */
  public void setCantot(Number value)
  {
    setAttributeInternal(CANTOT, value);
  }

  /**
   *
   *  Gets the attribute value for Peso, using the alias name Peso
   */
  public Number getPeso()
  {
    return (Number)getAttributeInternal(PESO);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Peso
   */
  public void setPeso(Number value)
  {
    setAttributeInternal(PESO, value);
  }

  /**
   *
   *  getAttrInvokeAccessor: generated method. Do not modify.
   */
  protected Object getAttrInvokeAccessor(int index, AttributeDefImpl attrDef) throws Exception
  {
    switch (index)
      {
      case IDBULTO:
        return getIdbulto();
      case IDDOC:
        return getIddoc();
      case IDLIN:
        return getIdlin();
      case CANTOT:
        return getCantot();
      case PESO:
        return getPeso();
      case CANRES:
        return getCanres();
      case CANPEN:
        return getCanpen();
      case ESTADO:
        return getEstado();
      case CREATEDBY:
        return getCreatedby();
      case MODIFIEDBY:
        return getModifiedby();
      case CREATEDON:
        return getCreatedon();
      case MODIFIEDON:
        return getModifiedon();
      case IDTIPMAC:
        return getIdtipmac();
      case RELLENO:
        return getRelleno();
      case UNIMAC:
        return getUnimac();
      case CANENT:
        return getCanent();
      case IDARTIF:
        return getIdartif();
      case DESCRIP:
        return getDescrip();
      case SGARESMAT:
        return getSgaresmat();
      case SGAEXISTENCIA:
        return getSgaexistencia();
      case SGABULTO:
        return getSgabulto();
      case SGALDOC:
        return getSgaldoc();
      default:
        return super.getAttrInvokeAccessor(index, attrDef);
      }
  }

  /**
   *
   *  setAttrInvokeAccessor: generated method. Do not modify.
   */
  protected void setAttrInvokeAccessor(int index, Object value, AttributeDefImpl attrDef) throws Exception
  {
    switch (index)
      {
      case IDBULTO:
        setIdbulto((Number)value);
        return;
      case IDDOC:
        setIddoc((Number)value);
        return;
      case IDLIN:
        setIdlin((Number)value);
        return;
      case CANTOT:
        setCantot((Number)value);
        return;
      case PESO:
        setPeso((Number)value);
        return;
      case CANRES:
        setCanres((Number)value);
        return;
      case CANPEN:
        setCanpen((Number)value);
        return;
      case ESTADO:
        setEstado((String)value);
        return;
      case IDTIPMAC:
        setIdtipmac((String)value);
        return;
      case RELLENO:
        setRelleno((String)value);
        return;
      case UNIMAC:
        setUnimac((Number)value);
        return;
      case CANENT:
        setCanent((Number)value);
        return;
      case IDARTIF:
        setIdartif((String)value);
        return;
      case DESCRIP:
        setDescrip((String)value);
        return;
      default:
        super.setAttrInvokeAccessor(index, value, attrDef);
        return;
      }
  }



  /**
   *
   *  Gets the associated entity SgabultoImpl
   */
  public SgabultoImpl getSgabulto()
  {
    return (SgabultoImpl)getAttributeInternal(SGABULTO);
  }

  /**
   *
   *  Sets <code>value</code> as the associated entity SgabultoImpl
   */
  public void setSgabulto(SgabultoImpl value)
  {
    setAttributeInternal(SGABULTO, value);
  }


  /**
   *
   *  Gets the associated entity SgaldocImpl
   */
  public SgaldocImpl getSgaldoc()
  {
    return (SgaldocImpl)getAttributeInternal(SGALDOC);
  }

  /**
   *
   *  Sets <code>value</code> as the associated entity SgaldocImpl
   */
  public void setSgaldoc(SgaldocImpl value)
  {
    setAttributeInternal(SGALDOC, value);
  }


  /**
   *
   *  Gets the associated entity oracle.jbo.RowIterator
   */
  public RowIterator getSgaresmat()
  {
    return (RowIterator)getAttributeInternal(SGARESMAT);
  }


  /**
   *
   *  Gets the attribute value for Canres, using the alias name Canres
   */
  public Number getCanres()
  {
    return (Number)getAttributeInternal(CANRES);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Canres
   */
  public void setCanres(Number value)
  {
    setAttributeInternal(CANRES, value);
    // Si la quantitat pendent es 0, es finalitza lbulto
    Number zero = new Number(0);
    if (value.equals(zero) && getCanpen().compareTo(zero) <= 0)
      setEstado("F");

  }

  /**
   *
   *  Gets the attribute value for Canpen, using the alias name Canpen
   */
  public Number getCanpen()
  {
    return (Number)getAttributeInternal(CANPEN);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Canpen
   */
  public void setCanpen(Number value)
  {
    setAttributeInternal(CANPEN, value);
  }

  /**
   *
   *  Gets the attribute value for Estado, using the alias name Estado
   */
  public String getEstado()
  {
    return (String)getAttributeInternal(ESTADO);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Estado
   */
  public void setEstado(String value)
  {
    if (getEstado() == null)
      setAttributeInternal(ESTADO, value);
    else
    {
      // Si ja esta anulada o finalitzada, no deixem actualitzar l'estat
      if (!(getEstado().equals(SgacdocImpl.ANULADA)
          || getEstado().equals(SgacdocImpl.FINALIZADA)))
        {
          setAttributeInternal(ESTADO, value);
            
          if (value.equals("F") || value.equals("A"))
          {
            // Mirem si la resta de linies estan acabades (nomes pels documents d'entrada)
            SgacdocImpl cdoc = null;
            
            SgaldocImpl ldocHere = getSgaldoc();
            if (ldocHere != null)
                cdoc = ldocHere.getSgacdoc();
            if (cdoc != null)
            {
            
            
            if (cdoc.getSgatipdoc().getTipmov().equals("E"))
            {
            
              RowIterator ldocs = cdoc.getSgaldoc();
              ldocs.reset();
              boolean bFinalitzarOrdre = true;
              while (ldocs.hasNext() && bFinalitzarOrdre)
              {
                SgaldocImpl ldoc = (SgaldocImpl)ldocs.next();
                RowIterator lbultos = ldoc.getSgalbulto();
                lbultos.reset();
                while (lbultos.hasNext() && bFinalitzarOrdre)
                {
                  SgalbultoImpl lbulto = (SgalbultoImpl)lbultos.next();
                  bFinalitzarOrdre = (lbulto.getEstado().equals(SgacdocImpl.ANULADA)
                              || lbulto.getEstado().equals(SgacdocImpl.FINALIZADA));
                }
              }
              if (bFinalitzarOrdre)
              {
                // TODO Michael 13.01.2017 This will call setEstado for each lbulto, for those lines which are not marked
                // as closed - and causes an error.
                cdoc.setEstado(SgacdocImpl.FINALIZADA);
                // Xavi, 11/05/05: Afegim a la capçalera el puesto desde el qual
                // s'ha tancat el document
                cdoc.setIdpuestofin(getSgabulto().getIdpuesto());
              }
            }
              
   
              // Si finalitzem el bulto, treiem l'assignació del puesto
              if (value.equals("F"))
              {
                SgabultoImpl bulto = getSgabulto();
                RowIterator lbultos = bulto.getSgalbulto();
                lbultos.reset();
                boolean bFinalitzarBulto = true;
                while (lbultos.hasNext() && bFinalitzarBulto)
                {
                  SgalbultoImpl lbulto = (SgalbultoImpl)lbultos.next();
                  bFinalitzarBulto = (lbulto.getEstado().equals(SgacdocImpl.ANULADA)
                                || lbulto.getEstado().equals(SgacdocImpl.FINALIZADA));
                }
                if (bFinalitzarBulto)
                  bulto.setIdpuesto(null);
                  
                // Michael 29.12.2016 Si es un trasllat, confirmar el trasllat
                SgaldocImpl ldoc = getSgaldoc();
                if (ldoc.isTrasllat())
                  ldoc.confirmarTrasllat();
              }
              // Michael 13.01.2016
              else
              {
                if (value.equals("A"))
                {
                  SgaldocImpl ldoc = getSgaldoc();
                  if (ldoc.isTrasllat())
                  {
                      RowIterator reserves = getSgaresmat();
                      reserves.reset();
                      
                      while (reserves.hasNext())
                      {
                        SgaresmatImpl resmat = (SgaresmatImpl)reserves.next();
                        //No s'anul.la el pendent
                        resmat.anularTrasllat();
                      }
                  }

                  
                }
              }
            }
          }
      }
    }

    // Si hem anulat la línia, anulem les reserves que hi hagin pendents
    if (value.equals("A"))
      anularReserves();
      
    
  }


  /**
   *
   *  Gets the attribute value for Createdby, using the alias name Createdby
   */
  public String getCreatedby()
  {
    return (String)getAttributeInternal(CREATEDBY);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Createdby
   */
  public void setCreatedby(String value)
  {
    setAttributeInternal(CREATEDBY, value);
  }

  /**
   *
   *  Gets the attribute value for Modifiedby, using the alias name Modifiedby
   */
  public String getModifiedby()
  {
    return (String)getAttributeInternal(MODIFIEDBY);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Modifiedby
   */
  public void setModifiedby(String value)
  {
    setAttributeInternal(MODIFIEDBY, value);
  }

  /**
   *
   *  Gets the attribute value for Createdon, using the alias name Createdon
   */
  public FlexiDate getCreatedon()
  {
    return (FlexiDate)getAttributeInternal(CREATEDON);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Createdon
   */
  public void setCreatedon(FlexiDate value)
  {
    setAttributeInternal(CREATEDON, value);
  }

  /**
   *
   *  Gets the attribute value for Modifiedon, using the alias name Modifiedon
   */
  public FlexiDate getModifiedon()
  {
    return (FlexiDate)getAttributeInternal(MODIFIEDON);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Modifiedon
   */
  public void setModifiedon(FlexiDate value)
  {
    setAttributeInternal(MODIFIEDON, value);
  }


  /**
   *
   *  Gets the attribute value for Idtipmac, using the alias name Idtipmac
   */
  public String getIdtipmac()
  {
    return (String)getAttributeInternal(IDTIPMAC);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Idtipmac
   */
  public void setIdtipmac(String value)
  {
    setAttributeInternal(IDTIPMAC, value);
  }


  /**
   *
   *  Gets the attribute value for Relleno, using the alias name Relleno
   */
  public String getRelleno()
  {
    return (String)getAttributeInternal(RELLENO);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Relleno
   */
  public void setRelleno(String value)
  {
    setAttributeInternal(RELLENO, value);
  }





  /**
   *
   *  Add attribute defaulting logic in this method.
   */
  protected void create(AttributeList attributeList)
  {
    super.create(attributeList);

    setAttributeInternal("Cantot", new Number(0));
    setAttributeInternal("Canres", new Number(0));
    setAttributeInternal("Canpen", new Number(0));
    setAttributeInternal("Canent", new Number(0));
    setAttributeInternal("Estado", "N");

  }


  public void confirmarEntrada(Number cancon, Number canres)
  {
    // La cantidad pendiente sólo se actualiza si ha habido una diferencia en lo que entran
    // sobre lo que piden entrar
    
    // Michael 11.02.2008 - TODO:
    // Puede haber dos reservas sobre esta entrada. Si es así, se estará calculando mal
    // Debe ser cancon - canres?
    // Michael 11.02.2008 TODO fin.
    
    Number difResCon = canres.subtract(cancon);
    if (!difResCon.equals(new Number (0)))
      setCanpen(getCanpen().add(difResCon));
    // Xavi, 04/04/05: Actualitzem canent
    // Xavi, 09/05/05: Canvio l'ordre ...
    setCanent(getCanent().add(cancon));
    setCanres(getCanres().subtract(canres));
  }


  public void anularEntrada(Number canres, boolean bAnularPendent)
  {
    if (!bAnularPendent)
      setCanpen(getCanpen().add(canres));
    setCanres(getCanres().subtract(canres));
  }

  /**
   * Reservar una cantidad para la entrada de material
   * <p><em>Nota: La existencia debe existir en Sgaexistencia, para poder insertar la reserva</em></p>
   * Se crea la reserva correspondiente en resmat
   * @param canres  La cantidad a reservar
   * @param idmac El mac donde realizar la reserva
   * @see SgamacImpl#reservarEntradaMaterial
   */
  public void reservarEntrada(String idmac, Number canres)
  {
    setCanres(getCanres().add(canres));
    setCanpen(getCanpen().subtract(canres));
    SgaresmatDefImpl resmat = (SgaresmatDefImpl)SgaresmatImpl.getDefinitionObject();
    SgaldocImpl ldoc = getSgaldoc();
    resmat.crearResmat(getDBTransaction(), idmac, ldoc.getIdart(), getIddoc(), getIdlin(), getIdbulto(), canres);
  }


  /**
   *
   *  Gets the attribute value for Unimac, using the alias name Unimac
   */
  public Number getUnimac()
  {
    return (Number)getAttributeInternal(UNIMAC);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Unimac
   */
  public void setUnimac(Number value)
  {
    setAttributeInternal(UNIMAC, value);
  }



  public void anularReserves()
  {
    RowIterator reserves = getSgaresmat();
    reserves.reset();
    while (reserves.hasNext())
    {
      SgaresmatImpl resmat = (SgaresmatImpl)reserves.next();
      // No s'anul.la el pendent
      resmat.anularReserva(false);
    }
  }





  /**
   * Retorna cert si s'ha insertat el lbulto, fals en cas contrari
   * @return
   * @param bulto
   */
  public boolean insertarLbulto(Number iddoc, ResultSet bulto)
  {
    boolean insertat = true;
    try
    {
      setIddoc(iddoc);
      setIdbulto(new Number(bulto.getBigDecimal("bul_id")));
      setIdlin(new Number(bulto.getBigDecimal("bul_id_detalle")));
      setPeso(new Number(bulto.getBigDecimal("bul_peso")));
      setCantot(new Number(bulto.getBigDecimal("bul_unidades")));
      setCanpen(new Number(bulto.getBigDecimal("bul_unidades")));
      setCanres(new Number(0));
      //Intentem donar valors per defecte a idtipmac i unimac
      Row row = tipmaclbulto(iddoc, getIdlin());
      if (row != null)
      {
        if (row.getAttribute("Idtipmac") != null)
          setIdtipmac((String)row.getAttribute("Idtipmac"));
        if (row.getAttribute("Unimac") != null)
          setUnimac((Number)row.getAttribute("Unimac"));
      }
    }
    catch(SQLException ex)
    {
      System.out.println("LBULTO Error inesperat: " + ex);
      insertat = false;
    }
    return insertat;
  }


  private Row tipmaclbulto(Number iddoc, Number idlin)
  {
    Row row = null;
    ViewObject vo = gettipmaclbultoView();
    if (vo != null)
    {
      vo.setWhereClauseParam(0, iddoc);
      vo.setWhereClauseParam(1, idlin);
      vo.setForwardOnly(true);
      vo.executeQuery();
      return vo.first();
    }
    return row;
  }


  private ViewObject gettipmaclbultoView()
  {
    ApplicationModule root = this.getDBTransaction().getRootApplicationModule();
    return(root.findViewObject("SgatipmaclbultoView1"));
  }

  /**
   *
   *  Gets the attribute value for Canent, using the alias name Canent
   */
  public Number getCanent()
  {
    return (Number)getAttributeInternal(CANENT);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Canent
   */
  public void setCanent(Number value)
  {
    setAttributeInternal(CANENT, value);
  }


  /**
   *
   *  Gets the attribute value for Idartif, using the alias name Idartif
   */
  public String getIdartif()
  {
    return (String)getAttributeInternal(IDARTIF);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Idartif
   */
  public void setIdartif(String value)
  {
    setAttributeInternal(IDARTIF, value);
  }

  /**
   *
   *  Gets the associated entity oracle.jbo.RowIterator
   */
  public RowIterator getSgaexistencia()
  {
    return (RowIterator)getAttributeInternal(SGAEXISTENCIA);
  }


  /**
   *
   *  Gets the attribute value for Descrip, using the alias name Descrip
   */
  public String getDescrip()
  {
    return (String)getAttributeInternal(DESCRIP);
  }

  /**
   *
   *  Sets <code>value</code> as the attribute value for Descrip
   */
  public void setDescrip(String value)
  {
    setAttributeInternal(DESCRIP, value);
  }

  /**
   * 
   *  Creates a Key object based on given key constituents
   */
  public static Key createPrimaryKey(Number idbulto, Number iddoc, Number idlin)
  {
    return new Key(new Object[] {idbulto, iddoc, idlin});
  }






















}